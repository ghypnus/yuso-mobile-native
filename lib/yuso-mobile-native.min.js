"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var uuid=require("uuid"),getQueryString=function(e){var t=null,o=location.hash?-1!==location.hash.indexOf("?")?"?"+location.hash.split("?")[1]:location.hash:location.search;if(-1!=(o=decodeURIComponent(o)).indexOf("?"))for(var n=o.substr(1).split("&"),i=0;i<n.length;i++)if(n[i].split("=")[0]==e){t=unescape(n[i].split("=")[1]);break}return t},configUrl="dingding/getsign/",checkUrl="dingding/checklogin/",corpId=getQueryString("corpid"),DdCore={url:"",isAutoLogin:function(e){var t=this;this.url=e.url;var o=e.callback;this.getConfig().then(function(e){t.getAuthCode(e.response,function(e){t.checkAutoLogin(!1,e.code).then(function(e){e.success?o(e.response):o({})})})})},getConfig:function(){return axios.request(this.url,""+configUrl+corpId,{hideError:!0,type:"get",params:{}})},getAuthCode:function(e,t){dd.config({agentId:e.agentId,corpId:corpId,timeStamp:e.timeStamp,nonceStr:e.nonceStr,signature:e.signature,jsApiList:["device.base.getUUID","device.base.getInterface","device.geolocation.get","runtime.info","biz.contact.choose","device.notification.confirm","device.notification.alert","device.notification.prompt","biz.ding.post","biz.util.openLink"]}),dd.ready(function(){dd.runtime.permission.requestAuthCode({corpId:corpId,onSuccess:t,onFail:function(e){console.log(e)}})}),dd.error(function(e){console.log("dd error: "+JSON.stringify(e))})},checkAutoLogin:function(e,t){var o=e?"dduserid/":"authcode/";return axios.request(this.url,checkUrl+o+corpId+"/"+t,{type:"get",params:{noToken:!0}})},getGPS:function(e,t){dd.ready(function(){dd.device.geolocation.get({targetAccuracy:200,coordinate:1,withReGeocode:e,onSuccess:function(e){t&&t(e)},onFail:function(e){console.log(JSON.stringify(e))}})})},getWiFi:function(t){dd.ready(function(){dd.device.base.getInterface({onSuccess:function(e){t&&t(e)},onFail:function(e){console.log(JSON.stringify(e))}})})},getUUID:function(t){dd.ready(function(){dd.device.base.getUUID({onSuccess:function(e){t&&t(e)},onFail:function(){t&&t()}})})}},DdUI={setTitle:function(e){dd.biz.navigation.setTitle({title:e});$.i18n.my_setTitle,$.i18n.search;dd.biz.navigation.setRight({show:!1,control:!0,text:"",onSuccess:function(){}})},setEvent:function(t){dd.ready(function(){-1<navigator.userAgent.indexOf("Android")?document.addEventListener("backbutton",function(e){e.preventDefault(),t()},!1):dd.biz.navigation.setLeft({show:!0,control:!0,showIcon:!0,onSuccess:function(){t()}})})},close:function(){dd.biz.navigation.close()}},isEmptyObject=function(e){return null==e||0===Object.keys(e).length},getQueryString$1=function(e){var t=null,o=location.hash?-1!==location.hash.indexOf("?")?"?"+location.hash.split("?")[1]:location.hash:location.search;if(-1!=(o=decodeURIComponent(o)).indexOf("?"))for(var n=o.substr(1).split("&"),i=0;i<n.length;i++)if(n[i].split("=")[0]==e){t=unescape(n[i].split("=")[1]);break}return t},_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},cookiePrefix="LOGIN_WECHAT_";function getCookie(e){var t,o=new RegExp("(^| )"+cookiePrefix+e+"=([^;]*)(;|$)");if(t=document.cookie.match(o)){var n=null;try{n=decodeURIComponent(t[2])}catch(e){n=t[2]}try{n=JSON.parse(n)}catch(e){}return n}return null}function setCookie(e,t,o){var n="";if(0!=(o=o||0)){var i=new Date;i.setTime(i.getTime()+1e3*o),n="; expires="+i.toGMTString()}document.cookie=cookiePrefix+e+"="+escape(t)+n+"; path=/"}var WeCore={url:"",isAutoLogin:function(t){var o=this;"2"===getQueryString$1("type")&&setCookie("wechatType","corp");var e=getQueryString$1("customerCode");e&&setCookie("customerCode",e);var n=getQueryString$1("code");n&&setCookie("code",n),this.getSign(function(e){o.setConfig(e,function(){o.checkAutoLogin(t)})})},getCustomerCode:function(){return getCookie("customerCode")},getWechatType:function(){return getCookie("wechatType")},getWechatCode:function(){return getCookie("code")},getOpenId:function(){return getCookie("openId")},getSign:function(t){var e={url:location.href.split("#")[0]},o=this.getWechatType();e.customerCode=this.getCustomerCode(),e.type="corp"===o?"2":"1",axios.post("/platform/wechat/wechatSign.nolog",e).then(function(e){t&&t(e)})},setConfig:function(e,t){wx.config({debug:!!e.debug,appId:e.appId,timestamp:e.timestamp,nonceStr:e.nonceStr,signature:e.signature,jsApiList:e.jsApiList||["getLocation","onHistoryBack","closeWindow"]}),wx.ready(function(){t&&t()})},checkAutoLogin:function(t){var e={code:this.getWechatCode()},o=this.getWechatType();e.customerCode=this.getCustomerCode(),e.type="corp"===o?"2":"1",axios.post("/platform/wechat/wechatCheckLogin.nolog",e).then(function(e){e&&e.user&&e.user.openId&&setCookie("openId",e.user.openId),t(e)})},logOut:function(t){var e={openId:this.getOpenId(),type:"corp"===this.getWechatType()?"2":"1",customerCode:this.getCustomerCode()};axios.post("/platform/wechat/wechatLogOut.nolog",e).then(function(e){t&&t(e)})},getOS:function(){var e="",t=navigator.userAgent;return-1<t.indexOf("Android")?e="android":t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)&&(e="ios"),e},getGPS:function(t){var o=this;"android"===this.getOS()?this.getSign(function(e){o.setConfig(e,function(){wx.getLocation({type:"gcj02",success:function(e){t&&t(e)},fail:function(){t&&t(null)}})})}):wx.getLocation({type:"gcj02",success:function(e){t&&t(e)},fail:function(){t&&t(null)}})},openBluetoothAdapter:function(t){wx.openBluetoothAdapter({success:function(e){console.info("openBluetoothAdapter success",e),t(_extends({},e,{isSuccess:!0}))},fail:function(e){t(_extends({},e,{isSuccess:!1}))}})},getWifi:function(t){if("corp"===this.getWechatType()){var o=this;o.getSign(function(e){e.jsApiList=["startWifi","getConnectedWifi"],o.setConfig(e,function(){wx.startWifi({success:function(e){console.info("startWifi success",e),wx.getConnectedWifi({success:function(e){console.log("getConnectedWifi success",e),t(e.wifi)},fail:function(e){console.log("getConnectedWifi fail",e),t({})}})},fail:function(e){console.log("startWifi fail",e),t({})}})})})}else t({})},getBluetooth:function(o,n){var i=this;if("corp"===this.getWechatType()){var c=this;c.getSign(function(e){var t=_extends({},e,{jsApiList:["openBluetoothAdapter","startBeaconDiscovery","stopBeaconDiscovery","onBeaconUpdate"]});c.setConfig(t,function(){c.getBluetoothCount=0,c.openBluetoothAdapter(function(e){e.isSuccess?(c.isBluetoothStopping=!1,c.isBluetoothStoped=!1,wx.startBeaconDiscovery({uuids:o.uuids,success:function(e){console.info("startBeaconDiscovery success",e),wx.onBeaconUpdate(function(e){console.info("onBeaconUpdate update",e),c.beacons=e.beacons,c.isBluetoothStopping||(c.isBluetoothStopping=!0,wx.stopBeaconDiscovery({success:function(){n({success:!0,list:i.beacons}),c.isBluetoothStoped=!0,c.isBluetoothStopping=!1}}))})},complete:function(e){setTimeout(function(){console.info("complete",c.isBluetoothStopping,c.isBluetoothStoped,e),c.isBluetoothStoped||wx.stopBeaconDiscovery()},1e4)},fail:function(e){console.info("startBeaconDiscovery fail",c.isBluetoothStopping,c.isBluetoothStoped,e),wx.stopBeaconDiscovery(),n({success:!1,error:e})}})):n({success:!1,error:"请开启蓝牙"})})})})}else n([])},setEvent:function(e){wx.ready(function(){try{wx.onHistoryBack(function(){return e&&e(),!1})}catch(e){console.warn(e+", 请使用企业微信平台登录")}})},close:function(){wx.closeWindow()}},cookiePrefix$1="LOGIN_LANXIN_";function getCookie$1(e){var t,o=new RegExp("(^| )"+cookiePrefix$1+e+"=([^;]*)(;|$)");if(t=document.cookie.match(o)){var n=null;try{n=decodeURIComponent(t[2])}catch(e){n=t[2]}try{n=JSON.parse(n)}catch(e){}return n}return null}function setCookie$1(e,t,o){var n="";if(0!=(o=o||0)){var i=new Date;i.setTime(i.getTime()+1e3*o),n="; expires="+i.toGMTString()}document.cookie=cookiePrefix$1+e+"="+escape(t)+n+"; path=/"}var LxCore={url:"",isAutoLogin:function(e){var t=getQueryString$1("customerCode"),o=getQueryString$1("code");t&&setCookie$1("customerCode",t),o&&setCookie$1("code",o),this.checkAutoLogin(e)},checkAutoLogin:function(t){var e={code:this.getLanxinCode(),customerCode:this.getCustomerCode(),type:"3"};axios.post("/platform/wechat/wechatCheckLogin.nolog",e).then(function(e){e&&e.user&&e.user.openId&&setCookie$1("openId",e.user.openId),t(e)})},logOut:function(t){var e={openId:this.getOpenId(),customerCode:this.getCustomerCode(),type:"3"};axios.post("/platform/wechat/wechatLogOut.nolog",e).then(function(e){t&&t(e)})},getGPS:function(t){lx.getLocation({type:"gcj02",success:function(e){return t&&t(e)},fail:function(){return t&&t(null)}})},getWifi:function(t){lx.wifiDeviceInfo({success:function(e){return t(e)},fail:function(){return t({})}})},getCustomerCode:function(){return getQueryString$1("customerCode")||getCookie$1("customerCode")},getLanxinCode:function(){return getQueryString$1("code")||getCookie$1("code")},getOpenId:function(){return getCookie$1("openId")},getOS:function(){var e="",t=navigator.userAgent;return-1<t.indexOf("Android")?e="android":t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)&&(e="ios"),e}},MapCore={getGPS:function(t){var e=void 0,o=void 0;(e=new AMap.Map("")).plugin("AMap.Geolocation",function(){o=new AMap.Geolocation({enableHighAccuracy:!0,timeout:1e4}),e.addControl(o),o.getCurrentPosition(),AMap.event.addListener(o,"complete",function(e){t&&t({longitude:e.position.getLng(),latitude:e.position.getLat()})}),AMap.event.addListener(o,"error",function(e){t&&t()})})}},getOS=function(){var e={},t=navigator.userAgent;return-1<t.indexOf("DingTalk")?e.type="dd":-1<t.indexOf("MicroMessenger")?e.type="wechat":-1<t.indexOf("Lanxin")?e.type="lanxin":-1<t.indexOf("Android")||-1<t.indexOf("Adr")?e.type=_isNativeAndroid()?"android":"h5":t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?e.type=_isNativeIos()?"ios":"h5":e.type="windows",e},_isNativeAndroid=function(){var t=!0;try{android.callWithDict(JSON.stringify({method:"test"}))}catch(e){t=!1}return t},_isNativeIos=function(){var t=!0;try{ios.callWithDict({method:"test"})}catch(e){t=!1}return t},Native={OS:getOS(),callbackMap:new Map,isNativeAndroid:function(){return _isNativeAndroid()},isNativeIos:function(){return _isNativeIos()},getNavigation:function(e){var t=1;switch(this.OS.type){case"dd":t=e?3==e?2:e:4;break;default:e&&(t=e)}return t},setDingTalkMenu:function(e,t){switch(this.OS.type){case"dd":DdUI.setEvent(function(){0<=t.indexOf(e.location.pathname)?DdUI.close():e.goBack()})}},setTitle:function(e){switch(this.OS.type){case"dd":DdUI.setTitle(e)}},getCache:function(e,t){var o="";switch(this.OS.type){case"android":this.callNative({method:"getCache",key:e},function(e){t?t(e):o=e});break;default:o=window.localStorage.getItem(e)}return o},setCache:function(e,t){switch(this.OS.type){case"android":this.callNative({method:"setCache",key:e,value:t});break;default:window.localStorage.setItem(e,t)}},removeCache:function(e){switch(this.OS.type){case"android":this.callNative({method:"removeCache",key:e});break;default:window.localStorage.removeItem(e)}},login:function(e,t){switch(this.OS.type){case"dd":e.dingTalkLogin(t);break;case"wechat":t.wechatType=WeCore.getWechatType(),e.weChatLogin(t);break;case"lanxin":e.lanXinLogin(t);break;default:e.login(t)}},isLogin:function(t){var o=this;switch(console.warn("this.OS.type:",this.OS.type),this.OS.type){case"dd":DdCore.isAutoLogin({url:url,callback:function(e){isEmptyObject(e)?t(!1):(null!=e.dduserid&&o.setCache("ddUserId",e.dduserid),o.setCache("userLogin",e.userinfo),t(e.islogin))}});break;case"wechat":WeCore.isAutoLogin(function(e){t(e)});break;case"lanxin":LxCore.isAutoLogin(function(e){return t(e)});break;case"android":this.getCache("",function(e){t(e)});break;default:t({user:JSON.parse(this.getCache("userInfo")),token:this.getCache("token")})}},exit:function(t){switch(this.OS.type){case"dd":var e=this.getCache("ddUserId");axios.post("/dingding/logout/"+e,{type:"get",params:{}}).then(function(e){e.success,t&&t(e)});break;case"wechat":WeCore.logOut(t);break;case"lanxin":LxCore.logOut(t);break;default:t&&t()}},callNative:function(e,t){var o=uuid.v4(),n={_callback_key_:o};for(var i in"string"==typeof e&&(e={method:e}),e)n[i]=e[i];switch(this.callbackMap.set(o,t),this.OS.type){case"ios":ios.callWithDict(n);break;case"android":android.callWithDict(JSON.stringify(n))}},callFront:function(e,t){var o=JSON.parse(t);this.callbackMap.has(e)&&(this.callbackMap.get(e)(o),this.callbackMap.delete(e))},getValidateList:function(e,t,o){var n=this,i=[],c=o||{num:"密码解锁",hand:"手势解锁",finger:"指纹解锁"};switch(this.OS.type){case"dd":case"android":i=1==e?[{pwd_type:"num",label:c.num},{pwd_type:"hand",label:c.hand}]:t.filter(function(e){return"1"==e.enable&&("hand"==e.pwd_type||"num"==e.pwd_type)});break;case"ios":1==e?(i=[{pwd_type:"num",label:c.num},{pwd_type:"hand",label:c.hand}],this.OS.fingerAllow&&i.push({pwd_type:"finger",label:c.finger})):i=t.filter(function(e){return"finger"==e.pwd_type?n.OS.fingerAllow&&"1"==e.enable:"1"==e.enable});break;default:i=1==e?[{pwd_type:"num",label:c.num},{pwd_type:"hand",label:c.hand}]:t.filter(function(e){return"1"==e.enable&&("hand"==e.pwd_type||"num"==e.pwd_type)})}return i},log:function(e,t){switch(this.OS.type){case"dd":case"wechat":$.get("./error?value="+t);break;case"android":case"ios":this.callNative({method:"log",path:e,value:t});break;default:$.get("./error?value="+t)}},getSystemInfo:function(t){var o={success:!0,device:""};switch(this.OS.type){case"dd":DdCore.getUUID(function(e){e&&(o.device=e.uuid),t&&t(o)});break;case"wechat":var e=this.getCache("openId");o.device=e,t&&t(o);break;case"lanxin":t&&t({device:this.getCache("openId")});break;case"android":case"ios":this.callNative("getSystemInfo",function(e){t&&t(e)});break;default:t&&t(o)}},getGPS:function(e,o){var t=Object.assign({},{method:"getGPS"},e);switch(this.OS.type){case"dd":var n=e.recode;DdCore.getGPS(n,function(e){var t=Object.assign({},{success:!0},e);o&&o(t)});break;case"wechat":WeCore.getGPS(function(e){var t={success:!1};null!=e&&(t=Object.assign({},{success:!0},e)),o&&o(t)});break;case"lanxin":LxCore.getGPS(function(e){var t={success:!1};null!=e&&(t=Object.assign({},{success:!0},e)),o&&o(t)});break;case"android":case"ios":this.callNative(t,function(e){o&&o(e)});break;case"h5":MapCore.getGPS(function(e){var t=Object.assign({},{success:!0},e);o&&o(t)})}},getWiFi:function(i){switch(this.OS.type){case"dd":DdCore.getWiFi(function(e){var t={mac:e.macIp,name:e.ssid};i&&i(t)});break;case"wechat":WeCore.getWifi(function(e){var t={};e.BSSID&&(t.mac=e.BSSID.toLowerCase(),t.name=e.SSID),i&&i(t)});break;case"lanxin":LxCore.getWifi(function(e){var t={};e.bssid&&(t.mac=e.bssid.toLowerCase(),t.name=e.ssid),i&&i(t)});break;case"android":case"ios":this.callNative({method:"getWiFi"},function(e){if(e.mac){var t=[],o=e.mac.split(":");for(var n in o)1==o[n].length&&(o[n]="0"+o[n]),t.push(o[n]);e.mac=t.join(":")}i&&i(e)})}},getBlueTooth:function(e,t){switch(this.OS.type){case"wechat":WeCore.getBluetooth(e,function(e){t&&t(e)});break;case"android":case"ios":this.callNative({method:"getBlueTooth"},function(e){t&&t(e)});break;default:t&&t({success:!0,list:[]})}}};void 0===window.Native&&(window.Native=Native);var index=window.Native;exports.Native=index;
